# API错误码说明

## 概述

本文档详细说明了Nancalacc API中使用的错误码，包括通用错误码和业务错误码。

## 错误响应格式

所有API错误响应都遵循统一的格式：

```json
{
  "code": 10001,
  "message": "参数错误",
  "details": {
    "field": "name",
    "reason": "字段不能为空"
  },
  "request_id": "req_1234567890"
}
```

## 通用错误码

| 错误码 | 说明 | HTTP状态码 | 解决方案 |
|--------|------|------------|----------|
| 10001  | 参数错误 | 400 | 检查请求参数格式和必填字段 |
| 10002  | 未授权 | 401 | 检查认证令牌是否有效 |
| 10003  | 禁止访问 | 403 | 检查用户权限 |
| 10004  | 资源不存在 | 404 | 检查资源ID是否正确 |
| 10005  | 服务器内部错误 | 500 | 联系技术支持 |
| 10006  | 服务不可用 | 503 | 稍后重试 |
| 10007  | 请求超时 | 408 | 检查网络连接或稍后重试 |
| 10008  | 请求过于频繁 | 429 | 降低请求频率 |
| 10009  | 请求体过大 | 413 | 减少请求数据量 |
| 10010  | 不支持的媒体类型 | 415 | 检查Content-Type头 |

## 业务错误码

### 账户管理 (20000-20099)

| 错误码 | 说明 | HTTP状态码 | 解决方案 |
|--------|------|------------|----------|
| 20001  | 账户已存在 | 409 | 检查账户名称是否重复 |
| 20002  | 账户不存在 | 404 | 检查账户ID是否正确 |
| 20003  | 账户状态异常 | 400 | 检查账户状态 |
| 20004  | 账户已被禁用 | 403 | 联系管理员启用账户 |
| 20005  | 账户名称格式错误 | 400 | 使用正确的命名格式 |
| 20006  | 邮箱格式错误 | 400 | 使用有效的邮箱地址 |
| 20007  | 账户创建失败 | 500 | 稍后重试或联系技术支持 |
| 20008  | 账户更新失败 | 500 | 稍后重试或联系技术支持 |
| 20009  | 账户删除失败 | 500 | 稍后重试或联系技术支持 |
| 20010  | 账户列表获取失败 | 500 | 稍后重试或联系技术支持 |

### 同步操作 (20100-20199)

| 错误码 | 说明 | HTTP状态码 | 解决方案 |
|--------|------|------------|----------|
| 20101  | 同步任务进行中 | 409 | 等待当前任务完成 |
| 20102  | 同步任务不存在 | 404 | 检查任务ID是否正确 |
| 20103  | 同步任务已失败 | 400 | 查看失败原因并重试 |
| 20104  | 同步任务已取消 | 400 | 重新启动同步任务 |
| 20105  | 同步配置错误 | 400 | 检查同步配置参数 |
| 20106  | 文件格式不支持 | 400 | 使用支持的文件格式 |
| 20107  | 文件大小超限 | 413 | 压缩文件或分批处理 |
| 20108  | 网络连接失败 | 500 | 检查网络连接 |
| 20109  | 外部服务不可用 | 503 | 稍后重试 |
| 20110  | 同步超时 | 408 | 增加超时时间或分批处理 |

### 认证授权 (20200-20299)

| 错误码 | 说明 | HTTP状态码 | 解决方案 |
|--------|------|------------|----------|
| 20201  | 用户名或密码错误 | 401 | 检查登录凭据 |
| 20202  | 账户被锁定 | 423 | 等待锁定时间结束或联系管理员 |
| 20203  | 令牌已过期 | 401 | 重新登录获取新令牌 |
| 20204  | 令牌无效 | 401 | 重新登录获取新令牌 |
| 20205  | 刷新令牌已过期 | 401 | 重新登录 |
| 20206  | 权限不足 | 403 | 联系管理员获取权限 |
| 20207  | 会话已过期 | 401 | 重新登录 |
| 20208  | 登录尝试次数过多 | 429 | 稍后重试 |
| 20209  | 双因素认证失败 | 401 | 检查验证码 |
| 20210  | 账户未激活 | 403 | 激活账户 |

### 文件操作 (20300-20399)

| 错误码 | 说明 | HTTP状态码 | 解决方案 |
|--------|------|------------|----------|
| 20301  | 文件上传失败 | 500 | 检查文件格式和大小 |
| 20302  | 文件下载失败 | 500 | 稍后重试 |
| 20303  | 文件不存在 | 404 | 检查文件路径 |
| 20304  | 文件已损坏 | 400 | 重新上传文件 |
| 20305  | 存储空间不足 | 507 | 清理存储空间 |
| 20306  | 文件类型不支持 | 400 | 使用支持的文件类型 |
| 20307  | 文件处理失败 | 500 | 稍后重试 |
| 20308  | 文件权限错误 | 403 | 检查文件权限 |
| 20309  | 文件锁定中 | 423 | 等待文件解锁 |
| 20310  | 文件版本冲突 | 409 | 解决版本冲突 |

## 错误处理最佳实践

### 1. 客户端错误处理

```javascript
// JavaScript示例
async function handleApiError(response) {
    if (!response.ok) {
        const error = await response.json();
        
        switch (error.code) {
            case 10001:
                console.error('参数错误:', error.details);
                break;
            case 10002:
                // 重新登录
                await refreshToken();
                break;
            case 20001:
                alert('账户已存在，请使用其他名称');
                break;
            default:
                console.error('未知错误:', error.message);
        }
        
        throw new Error(error.message);
    }
    
    return response.json();
}
```

### 2. 重试机制

```javascript
// 自动重试机制
async function apiCallWithRetry(fn, maxRetries = 3) {
    for (let i = 0; i < maxRetries; i++) {
        try {
            return await fn();
        } catch (error) {
            if (error.code === 10005 || error.code === 10006) {
                // 服务器错误，可以重试
                if (i === maxRetries - 1) throw error;
                await new Promise(resolve => setTimeout(resolve, 1000 * (i + 1)));
            } else {
                // 客户端错误，不重试
                throw error;
            }
        }
    }
}
```

### 3. 错误监控

```javascript
// 错误监控和上报
function reportError(error, context) {
    const errorReport = {
        code: error.code,
        message: error.message,
        details: error.details,
        context: context,
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href
    };
    
    // 发送到错误监控服务
    fetch('/api/errors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(errorReport)
    });
}
```

## 错误码更新

### 版本历史

- **v1.0.0** (2024-01-01): 初始版本
- **v1.1.0** (2024-02-01): 添加文件操作错误码
- **v1.2.0** (2024-03-01): 添加认证授权错误码

### 向后兼容性

- 新增错误码不会影响现有功能
- 废弃的错误码会保留至少一个版本周期
- 错误码变更会在更新日志中说明

## 联系支持

如果遇到未列出的错误码或需要技术支持，请：

1. 记录完整的错误信息
2. 包含请求ID和上下文信息
3. 联系技术支持团队
4. 提供复现步骤

**技术支持邮箱**: support@nancalacc.com  
**技术支持电话**: 400-123-4567  
**在线文档**: https://docs.nancalacc.com/api/errors 